# NodeJS

### NodeJS란?

NodeJS는 크롬 V8 자바스크립트 엔진으로 빌드된 자바스크립트 런타임입니다. (런타임 = 개발환경) NodeJS는 이벤트 기반, 논 블로킹 I/O 모델을 사용해 가볍고 효율적입니다. NodeJS의 패키지 생태계인 npm은 세계에서 가장 큰 오픈소스 라이브러리 생태계이기도 합니다.

### 런타임

**특정 언어로 만든 프로그램들을 실행할 수 있는 환경**을 의미합니다. 따라서 노드는 자바스크립트 프로그램을 컴퓨터에서 실행할 수 있게 해줍니다. 기존 자바스크립트 프로그램은 브라우저 위에서만 사용할 수 있었습니다. (브라우저도 일종의 자바스크립트 런타임입니다.) 브라우저외의 환경에서 자바스크립트를 실행할 수 있게 하려는 여러 시도가 있었지만 자바스크립트 실행 속도 문제 때문에 큰 호응을 얻지는 못했습니다. 하지만 2008년 구글이 V8엔진을 사용하여 크롬을 출시하고 상황이 변했습니다. V8엔진은 다른 자바스크립트 엔진보다 훨씬 빨랐고 오픈소스로 공개되었습니다. 속도 문제가 해결되니 여러가지 시도들이 진행되었고 라이언 달이 2009년 V8 엔진 기반의 노드프로젝트를 실시했습니다. V8외에 노드는 libuv라는 라이브러리를 사용합니다. 이 둘은 NodeJS를 구성하는 가장 기초적인 것으로 생각하시면 됩니다. libuv 라이브러리는 **이벤트 기반, 논블로킹 I/O 모델**을 구현하고 있고 이를 바탕으로 NodeJS는 가볍고 효율적으로 실행될 수 있었습니다.

### 이벤트 기반

이벤트 기반이란 이벤트가 발생할 시, 미리 정해둔 작업을 수행하는 방식을 의미합니다. 이벤트로는 클릭, 네트워크 요청, 드래그 등 여러가지가 존재합니다. 이벤트 기반 시스템에서는 특정 이벤트가 발생했을 때 어떤 작업을 할지 미리 정해야합니다. 이것은 이벤트 리스너에 콜백함수를 등록하는 방법을 사용합니다. 노드는 이벤트 기반 방식으로 작동하므로 이벤트 발생시, 이벤트 리스너에 정해둔 콜백 함수를 호출합니다. 발생한 이벤트가 없거나 발생한 이벤트를 다 처리한 후에는 다음 이벤트가 발생할 때까지 대기합니다.

이러한 이벤트 기반 모델에서는 이벤트 루프 개념이 나타납니다. 한번에 여러 이벤트가 발생할 때, 어떤 순서로 이벤트에 해당하는 콜백함수를 호출할지 이벤트 루프가 판단합니다.

```javascript
function run(){
    console.log("3초 후 실행");
}
console.log("시작");
setTimeout(run, 3000);
console.log("끝");
```

```powershell
PS C:\Users\user>
시작
끝
3초 후 실행
```

3초 뒤에 run 함수를 실행하는 코드입니다. 콘솔 결과는 쉽게 예측할 수 있지만, 이를 호출 스택으로 설명하기는 힘듭니다. setTimeout 함수의 콜백 함수인 run이 호출스택에 언제 들어가는지를 파악하기 힘들기 때문입니다. 이를 파악하기 위해 이벤트 루프, 테스크 큐, 백그라운드에 대해 가볍게 알아봅시다.

- **이벤트 루프**: 이벤트 발생 시 호출한 콜백 함수들을 관리하고, 호출된 콜백 함수의 실행 순서를 결정하는 역할을 담당합니다. 노드가 종료될 때까지 이벤트 처리를 위한 작업을 반복하기 때문에 루프라고 합니다.
- **테스크 큐**: 이벤트 발생 후 호출되어야 할 콜백함수들이 대기하는 곳입니다. 콜백들이 이벤트 루프가 정한 순서대로 대기하고 있으므로 콜백 큐라고도 합니다.
- **백그라운드**: 타이머나 I/O 작업 콜백 또는 이벤트 리스너들이 대기하는 곳입니다.

위 코드를 실행하면 먼저 main 함수가 호출 스택에 들어갑니다. 그 다음 setTimeout 함수가 호출스택에 쌓입니다. 그 다음 더 이상 호출스택에 쌓일 함수가 없으므로 setTimeout가 실행됩니다. setTimeout 함수가 실행되면 콜백 함수인 run 함수를 백그라운드로 보내고 호출스택에서 빠집니다. 그 다음 main 함수도 호출스택에서 제거됩니다. 백그라운드에서는 3초 후, run 함수를 태스크 큐로 보냅니다. 이벤트 루프는 테스크 큐에 있는 콜백 함수들을 정해진 규칙에 따라 호출스택으로 가져갑니다.

main함수가 호출스택에서 빠져나가면서, 이제 run 함수를 태스크 큐로부터 가져와 호출스택에 넣고 실행합니다. 실행된 run 함수는 호출스택에서 사라지고, 이벤트 루프는 테스크 콜백 함수가 들어올때까지 계속 대기합니다.

만약 호출스택에 함수들이 너무 많이 쌓여 있으면 3초 후에도 run 함수가 실행되지 않을 수도 있습니다. 이벤트 루프는 호출스택이 비어 있는 경우에만 테스크 큐에서 콜백함수를 가져오기 때문입니다.

### 논블로킹 I/O

이벤트 루프를 활용하면 오래걸리는 작업을 효율적으로 처리할 수 있습니다. 오래 걸리는 함수를 백그라운드로 보내 다른 코드들을 먼저 실행하고 그 함수가 테스크 큐를 거쳐 호출스택으로 올라와 실행하는 방법입니다. 이러한 방식을 논블로킹 방식이라고 합니다. 논블로킹이란 이전 작업이 완료될때까지 멈추지않고 다음 작업을 수행하는 것을 의미합니다. 이렇게하면 같은 작업을 더 짧은 시간 동안 처리할 수 있다는 장점이 있습니다. 하지만 자바스크립트는 싱글 스레드이기 때문에 모든 코드가 이 작업을 통해 시간적 이득을 가지지는 못합니다. 

I/O는 입력(Input)/출력(Output)을 의미합니다. 파일 시스템 접근이나 네트워크 요청과 같은 작업 모두 I/O 작업의 한 종류 입니다. 이러한 작업을 수행할 때, 노드는 논블로킹 I/O 방식으로 동작합니다.

논블로킹 방식 예제

```javascript
function longTimeTask(){
    console.log("작업 끝");
}
console.log("작업 시작");
setTimeout(longTimeTask, 0);
console.log("다른 작업 시작");
```

setTimeout(콜백, 0)은 코드를 논블로킹 방식으로 만들기 위해 사용하는 기법 중 하나입니다. setTimeout 함수의 콜백함수가 태스크 큐로 보내지므로 순서대로 실행되지 않습니다. 

### 싱글 스레드

스레드는 컴퓨터 작업을 처리할 수 있는 일손이라고 생각하면 됩니다. 노드는 싱글 스레드이기 때문에 주어진 작업을 혼자서 처리해야 합니다. 멀티 스레드의 경우에는 여러개의 스레드가 나눠서 일을 처리합니다. 자바스크립트와 노드에서 논블로킹이 중요한 이유는 바로 싱글 스레드이기 때문입니다. 한번에 하나의 일만 처리할 수 있으므로 어떠한 작업에서 블로킹이 발생하면 다음일을 처리할 수 없습니다.

쉽게 보면 여러개의 일을 동시에 처리하는 멀티 스레드가 싱글 스레드보다 좋아 보입니다. 하지만 반드시 그런 것은 아닙니다. 멀티스레드 + 블로킹 방식으로 작동하면 노는 스레드가 발생하는 문제점이 발생합니다.

그렇다면 멀티 스레드 + 논블로킹 방식으로 일을 처리하면 좋지 않을까 하는 생각이 들 수 있습니다. 실제로 노드도 싱글 스레드 여러개를 활용한 멀티 스레딩과 비슷한 기능을 활용할 수 있습니다. 하지만 엄밀히 말하면, 멀티스레딩이라기보다는 멀티 프로세싱에 가깝습니다. 여기서 프로세스와 스레드의 차이점에 대해 알아봅시다.

- 프로세스는 운영체제에서 할당하는 작업의 단위입니다. 노드나 인터넷 브라우저 같은 프로그램은 개별적인 프로세스입니다. 프로세스 간에는 메모리 등의 자원을 공유하지 않습니다.
- 스레드는 프로세스 내에서 실행되는 흐름의 단위입니다. 하나의 프로세스는 스레드를 여러개 가질 수 있습니다. 스레들은 부모 프로세스의 자원을 공유합니다. 즉, 같은 메모리에 접근할 수 있습니다.

사실 노드 프로세스도 내부적으로 여러개의 스레드를 가지고 있습니다. 하지만 제어할 수 있는 스레드가 하나뿐이므로 싱글 스레드라 부르는 것입니다. 노드는 스레드를 늘리는 대신, 프로세스 자체를 복사해 여러작업을 동시에 처리하는 멀티 프로세싱 방식을 사용합니다. 자바스크립트 언어가 싱글스레드 특성을 가지고 있기 때문입니다.

NodeJS의 장단점

|                       장점                        |                      단점                       |
| :-----------------------------------------------: | :---------------------------------------------: |
| 멀티 스레드 방식에 비해 컴퓨터 자원을 적게 사용함 | 싱글 스레드이기 때문에 CPU 코어를 하나만 사용함 |
|            I/O 작업이 많은 서버로 적합            |         CPU 작업이 많은 서버로는 부적합         |
|             멀티 스레드 방식보다 쉬움             |   하나뿐인 스레드가 멈추지 않도록 관리해야 함   |
|              웹 서버가 내장되어 있음              |  서버 규모가 커졌을 때 서버를 관리하기 어려움   |
|               자바스크립트를 사용함               |                  어중간한 성능                  |
|             JSON 형식과 호환하기 쉬움             |                                                 |

이와 같은 특성들을 살펴보면 노드는 개수는 많지만 크기는 작은 데이터를 실시간으로 주고 받는데 적합합니다. 네트워크, 데이터 베이스, 디스크 작업 같은 I/O에 특화되어 있기 때문입니다. 그러한 이유로 실시간 채팅, 주식 차트, JSON 데이터를 제공하는 API 서버등에서 노드를 많이 사용합니다.

하지만 이미지나 비디오 처리, 대규모 데이터 처리와 같이 CPU를 많이 사용하는 작업을 위한 서버로는 권장하지 않습니다.

### 함께보면 좋은 자료

- **노드 공식 사이트**: https://nodejs.org/ko 
- **노드 공식 사이트의 가이드**: https://nodejs.org/en/docs/guides/
- **이벤트 루프에 대한 시각적 설명**: http://latentflip.com/loupe
- **이벤트 루프에 대한 설명**: https://nodejs.org/ko/docs/guides/event-loop-timers-and-nexttick/ 
- **VS Code 공식 사이트**: https://code.visualstudio.com/